#ifndef MEDIAN_FILTER_H
#define MEDIAN_FILTER_H

#include <stdint.h>
#include <stdbool.h>

/**
 * @file median_filter.h
 * @brief Заголовочный файл для комбинированного медианного фильтра и скользящего среднего.
 */

/**
 * @struct CombinedFilter
 * @brief Структура для хранения состояния комбинированного фильтра.
 *
 * Содержит буфер для медианного фильтра и параметры для скользящего среднего.
 */
typedef struct {
    // Медианный фильтр
    float median_buffer[11];     /**< Буфер для медианного фильтра (размер 11). */
    uint8_t median_size;         /**< Размер буфера медианного фильтра (нечетный). */
    uint8_t median_index;        /**< Текущий индекс для вставки новой выборки. */

    // Скользящее среднее
    float sum;                    /**< Сумма значений для скользящего среднего. */
    float avg_buffer[11];         /**< Буфер для скользящего среднего (размер 11). */
    uint8_t avg_size;             /**< Размер буфера скользящего среднего. */
    uint8_t avg_index;            /**< Текущий индекс для вставки нового медианного значения. */
} CombinedFilter;

/**
 * @brief Инициализация комбинированного фильтра.
 *
 * @param filter Указатель на структуру комбинированного фильтра.
 * @param median_size Размер буфера медианного фильтра (должен быть нечетным).
 * @param avg_size Размер буфера скользящего среднего.
 * @return `true` в случае успешной инициализации, `false` в противном случае.
 */
bool combined_filter_init(CombinedFilter *filter, uint8_t median_size, uint8_t avg_size);

/**
 * @brief Обновление комбинированного фильтра с добавлением новой выборки.
 *
 * Добавляет новую выборку в медианный фильтр, вычисляет медиану, затем обновляет скользящее среднее.
 *
 * @param filter Указатель на структуру комбинированного фильтра.
 * @param sample Новая выборка для добавления.
 * @return Сглаженное значение после применения фильтра.
 */
float combined_filter_update(CombinedFilter *filter, float sample);

/**
 * @brief Освобождение ресурсов комбинированного фильтра.
 *
 * В данном случае ничего не делает, так как буферы статические.
 *
 * @param filter Указатель на структуру комбинированного фильтра.
 */
void combined_filter_deinit(CombinedFilter *filter);

#endif // MEDIAN_FILTER_H
